<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <changeSet id="17092021-1" author="Alexander Kamyhin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="users"/>
            </not>
        </preConditions>
        <comment>Создание таблицы USERS</comment>
        <sql>
            CREATE TABLE users
            (
                id           BIGSERIAL PRIMARY KEY,
                created      TIMESTAMP WITHOUT TIME ZONE,
                updated      TIMESTAMP WITHOUT TIME ZONE,
                status       VARCHAR(255) DEFAULT 'ACTIVE',
                comment      TEXT,
                username     VARCHAR(255),
                email        VARCHAR(255),
                password     VARCHAR(255),
                tg_user      BIGINT,
                tg_statement VARCHAR(255) DEFAULT 'NO STATEMENT',
                enabled      BOOLEAN,
                CONSTRAINT uc_users_email UNIQUE (email),
                CONSTRAINT uc_users_tg_user UNIQUE (tg_user),
                CONSTRAINT uc_users_username UNIQUE (username)
            );

            COMMENT
            ON TABLE users IS 'Список пользователей';

            COMMENT
            ON COLUMN users.id IS 'Уникальный идентификатор';
            COMMENT
            ON COLUMN users.created IS 'Дата создания записи';
            COMMENT
            ON COLUMN users.updated IS 'Дата изменения записи';
            COMMENT
            ON COLUMN users.status IS 'Состояние учетной записи пользователя';
            COMMENT
            ON COLUMN users.comment IS 'Комментарий';
            COMMENT
            ON COLUMN users.username IS 'Имя пользователя';
            COMMENT
            ON COLUMN users.email IS 'Email пользователя';
            COMMENT
            ON COLUMN users.password IS 'Пароль';
            COMMENT
            ON COLUMN users.tg_user IS 'Telegram user id';
            COMMENT
            ON COLUMN users.tg_statement IS 'Состояние чата телеграмм';
            COMMENT
            ON COLUMN users.enabled IS 'Включена ли запись';
        </sql>
    </changeSet>

    <changeSet id="17092021-2" author="Alexander Kamyhin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="roles"/>
            </not>
        </preConditions>
        <comment>Создание таблицы ROLES</comment>
        <sql>
            CREATE TABLE roles
            (
                id       BIGSERIAL PRIMARY KEY,
                created  TIMESTAMP WITHOUT TIME ZONE,
                updated  TIMESTAMP WITHOUT TIME ZONE,
                status   VARCHAR(255) DEFAULT 'ACTIVE',
                comment  TEXT,
                rolename VARCHAR(255)
            );

            COMMENT
            ON TABLE roles IS 'Список ролей пользователей';

            COMMENT
            ON COLUMN roles.id IS 'ID роли';
            COMMENT
            ON COLUMN roles.created IS 'Дата создания записи';
            COMMENT
            ON COLUMN roles.updated IS 'Дата изменения записи';
            COMMENT
            ON COLUMN roles.status IS 'Состояние роли';
            COMMENT
            ON COLUMN roles.comment IS 'Комментарий';
            COMMENT
            ON COLUMN roles.rolename IS 'Имя роли';
        </sql>
    </changeSet>

    <changeSet id="17092021-3" author="Alexander Kamyhin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="procurements"/>
            </not>
        </preConditions>
        <comment>Создание таблицы PROCUREMENTS</comment>
        <sql>
            CREATE TABLE procurements
            (
                id                     BIGSERIAL PRIMARY KEY,
                created                TIMESTAMP WITHOUT TIME ZONE,
                updated                TIMESTAMP WITHOUT TIME ZONE,
                status                 VARCHAR(255) DEFAULT 'ACTIVE',
                comment                TEXT,
                stage                  VARCHAR(255),
                uin                    VARCHAR(30)  NOT NULL,
                fz_number              INTEGER      NOT NULL,
                application_deadline   TIMESTAMP with time zone,
                contract_price         DECIMAL,
                procedure_type         VARCHAR(255),
                publisher_name         VARCHAR(555) NOT NULL,
                restrictions           TEXT,
                link_on_placement      VARCHAR(255) NOT NULL,
                application_secure     VARCHAR(255),
                contract_secure        VARCHAR(255),
                object_of              TEXT,
                last_updated_from_eis  date,
                date_time_last_updated date,
                date_of_placement      date,
                date_of_auction        TIMESTAMP with time zone,
                CONSTRAINT uc_procurements_uin UNIQUE (uin)
            );

            CREATE UNIQUE INDEX users_uin_u_idx ON procurements (uin);

            COMMENT
            ON TABLE procurements IS 'Список закупок';

            COMMENT
            ON COLUMN procurements.id IS 'Уникальный идентификатор';
            COMMENT
            ON COLUMN procurements.created IS 'Дата создания записи';
            COMMENT
            ON COLUMN procurements.updated IS 'Дата изменения записи';
            COMMENT
            ON COLUMN procurements.status IS 'Состояние записи';
            COMMENT
            ON COLUMN procurements.comment IS 'Комментарий';
            COMMENT
            ON COLUMN procurements.stage IS 'Этап закупки';
            COMMENT
            ON COLUMN procurements.uin IS 'Уникальный идентификатор закупки';
            COMMENT
            ON COLUMN procurements.fz_number IS 'Номер федерального закона';
            COMMENT
            ON COLUMN procurements.application_deadline IS 'Дата и время окончания срока подачи заявок';
            COMMENT
            ON COLUMN procurements.contract_price IS 'Начальная (максимальная) цена договора';
            COMMENT
            ON COLUMN procurements.procedure_type IS 'Тип закупки';
            COMMENT
            ON COLUMN procurements.publisher_name IS 'Наименование организации, осуществляющей размещение заявки';
            COMMENT
            ON COLUMN procurements.restrictions IS 'Ограничения и запреты';
            COMMENT
            ON COLUMN procurements.link_on_placement IS 'Ссылка на закупку на площадке размещения';
            COMMENT
            ON COLUMN procurements.application_secure IS 'Обеспечение заявки';
            COMMENT
            ON COLUMN procurements.contract_secure IS 'Обеспечение контракта';
            COMMENT
            ON COLUMN procurements.object_of IS 'Наименование закупки';
            COMMENT
            ON COLUMN procurements.last_updated_from_eis IS 'Дата размещения текущей редакции извещения';
            COMMENT
            ON COLUMN procurements.date_time_last_updated IS '';
            COMMENT
            ON COLUMN procurements.date_of_placement IS 'Дата размещения процедуры';
            COMMENT
            ON COLUMN procurements.date_of_auction IS 'Дата и время аукциона';
        </sql>
    </changeSet>

    <changeSet id="20032022-1" author="BJCreslin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="user_roles"/>
            </not>
        </preConditions>
        <comment>Создание таблицы USER-ROLES</comment>
        <sql>
            CREATE TABLE user_roles
            (
                user_id BIGINT NOT NULL,
                role_id BIGINT NOT NULL,
                PRIMARY KEY (user_id, role_id),
                CONSTRAINT FK_user_roles_user FOREIGN KEY (user_id) REFERENCES users (id),
                CONSTRAINT FK_user_roles_role FOREIGN KEY (role_id) REFERENCES roles (id)
            );
        </sql>
    </changeSet>

    <changeSet id="20032022-2" author="BJCreslin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="users_procurements"/>
            </not>
        </preConditions>
        <comment>Создание таблицы USERS-PROCUREMENTS</comment>
        <sql>
            CREATE TABLE users_procurements
            (
                user_id        BIGINT NOT NULL,
                procurement_id BIGINT NOT NULL,
                PRIMARY KEY (user_id, procurement_id),
                CONSTRAINT FK_users_procurements_user FOREIGN KEY (user_id) REFERENCES users (id),
                CONSTRAINT FK_users_procurements_procurement FOREIGN KEY (procurement_id) REFERENCES procurements (id)
            );
        </sql>
    </changeSet>
</databaseChangeLog>